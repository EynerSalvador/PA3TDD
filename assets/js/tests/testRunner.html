<!DOCTYPE html>
<html>
<head>
  <title>Jasmine Test Runner</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jasmine/3.6.0/jasmine.css">
  <style>
    body { padding: 20px; font-family: Arial; }
    #loading { color: #666; text-align: center; padding: 50px; }
    #status { margin: 20px 0; padding: 10px; border-radius: 4px; }
    .success { background: #e8f5e9; color: #2e7d32; }
    .error { background: #ffebee; color: #c62828; }
  </style>
</head>
<body>
  <div id="loading">Inicializando pruebas...</div>
  <div id="status"></div>

  <!-- Cargar Jasmine -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jasmine/3.6.0/jasmine.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jasmine/3.6.0/jasmine-html.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jasmine/3.6.0/boot.js"></script>

  <script>
    // 1. Configuración básica
    jasmine.DEFAULT_TIMEOUT_INTERVAL = 5000;
    const statusEl = document.getElementById('status');
    const loadingEl = document.getElementById('loading');

    function updateStatus(message, type = '') {
      statusEl.textContent = message;
      statusEl.className = type ? `status ${type}` : 'status';
      console.log('Status:', message);
    }

    // 2. Mock de fetch para Jasmine
    window.originalFetch = window.fetch;
    window.fetch = jasmine.createSpy('fetch').and.callFake((url) => {
      console.log('Mock fetch llamado para:', url);
      return Promise.resolve({
        ok: true,
        json: () => {
          if (url.includes('db.json')) {
            return Promise.resolve({
              projects: [{ id: 1, title: "Proyecto Test" }],
              skills: [{ id: 1, name: "Skill Test" }]
            });
          }
          return Promise.resolve({});
        }
      });
    });

    // 3. Carga secuencial de scripts
    async function loadScripts() {
      try {
        // Verificar rutas relativas desde testRunner.html
        const basePath = window.location.pathname.includes('assets/js/tests') 
          ? '../../..' 
          : '';

        updateStatus('Cargando Project.js...');
        await loadScript(`${basePath}/_data/models/Project.js`);
        
        updateStatus('Cargando Skill.js...');
        await loadScript(`${basePath}/_data/models/Skill.js`);
        
        updateStatus('Cargando pruebas...');
        await loadScript('Project.test.js');
        await loadScript('Skill.test.js');
        
        updateStatus('Pruebas cargadas ✅', 'success');
        loadingEl.style.display = 'none';
        
        // Iniciar Jasmine
        window.onload();
      } catch (error) {
        updateStatus(`Error: ${error.message}`, 'error');
        console.error('Error de carga:', error);
      }
    }

    function loadScript(src) {
      return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = src;
        script.onload = resolve;
        script.onerror = () => reject(new Error(`No se pudo cargar ${src}`));
        document.head.appendChild(script);
      });
    }

    // Iniciar cuando el DOM esté listo
    if (document.readyState === 'complete') {
      loadScripts();
    } else {
      document.addEventListener('DOMContentLoaded', loadScripts);
    }
  </script>
</body>
</html>
